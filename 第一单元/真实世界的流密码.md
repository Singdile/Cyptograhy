### CSS
Content Scramble System 使用流密码加密方式。

CSS 使用 **40 位密钥（5 字节）**，拆分为两个部分：

- 前两字节用于初始化一个 17 位的 LFSR（加上一个固定 “1” 位防止陷入全零状态）
- 后三字节用于初始化另一个 25 位 LFSR（同样加一个 “1” 位）

#### 生成伪随机流

在 CSS 中有两个 LFSR：

- 17 位寄存器（LFSR‑17）：使用密钥前 2 字节（16 位）进行初始化，并在第 4 位处**注入一个固定的 `1` 位**，确保寄存器的状态不会全为零

- 25 位寄存器（LFSR‑25）：使用密钥后 3 字节（24 位）初始化，同样在特定位置注入 `1` 作为“非零”保证

工作流程图见：[[CSS|CSS工作图]]

#### [[破解CSS|容易被破解]]
- 密钥空间太小，$2^{40}$ 
- 可由已知明文攻击破解


---
### Salsa20

Salsa20(k;r) := H(k,(r,0)) || H(k,(r,1)).....

#### 输入的状态矩阵
Salsa20 的输入是一个 64 字节（16 个 32-bit word）的状态矩阵。

分布如下图所示，其中每一块代表 4 个byte。

key表示密钥，共 32 bytes；

nonce 表示随机数，共 8 bytes；

counter 表示计数器， 共 8 bytes；

剩下 16  bytes，是常量值。

![[Pasted image 20250702105915.png]]

![[Pasted image 20250702105847.png]]


#### 生成key-stream
使用 “quarter-round” 函数将数据随机化。
该函数每一次应用于 一行 或者 一列 的数据。
```
quarter-round(a,b,c,d)

b ^= (a + d) <<< 7
c ^= (b + a) <<< 9
d ^= (c + b) <<< 13
a ^= (d + c) <<< 18

```

奇数轮：将quarter-round应用于每一列
偶数轮：将quarter-round应用于每一行

执行20次。最后将获得的状态矩阵与初始的状态矩阵按位异或，得到key-stream。

变换过程参考
[【动画密码学】Salsa20|流密码_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1Bj411q7Kr/?spm_id_from=333.337.search-card.all.click&vd_source=d10f461c8c5b1bc25e5585ce2b29b444)

文档参考
[逆向工程加密函数：RC4 和 Salsa20 |GoggleHeaded黑客](https://goggleheadedhacker.com/blog/post/reversing-crypto-functions?utm_source=chatgpt.com#salsa20-algorithm)


#### 加密/解密
使用得到的key-stream $\oplus$ 明文 = 密文，如果明文的bytes > 64,那么就将初始状态的 counter + 1，重新计算。
